<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>LabX ¬∑ Student Nexus</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap"
          rel="stylesheet">
    <style>
        :root {
            --bg-dark: #050511;
            --primary: #5b5fff;
            --primary-gradient: linear-gradient(135deg, #6366F1 0%, #A855F7 50%, #22C55E 100%);
            --primary-soft: rgba(99, 102, 241, 0.35);
            --glass: rgba(15, 15, 36, 0.9);
            --glass-soft: rgba(15, 15, 36, 0.7);
            --glass-border: rgba(255, 255, 255, 0.1);
            --text-main: #f9fafb;
            --text-secondary: #9CA3AF;
            --accent-cyan: #06B6D4;
            --accent-purple: #A855F7;
            --accent-gold: #FACC15;
            --success: #22C55E;
            --danger: #F97373;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            user-select: none;
        }

        body {
            background: radial-gradient(circle at 0 0, rgba(96, 165, 250, .25) 0, transparent 55%),
                        radial-gradient(circle at 100% 0, rgba(244, 114, 182, .25) 0, transparent 55%),
                        var(--bg-dark);
            min-height: 100vh;
            padding-bottom: 96px;
            overflow-x: hidden;
            color: var(--text-main);
            position: relative;
        }

        /* --- BACKGROUND + PARALLAX --- */
        .bg-layer {
            position: fixed;
            inset: 0;
            overflow: hidden;
            pointer-events: none;
            z-index: 0;
        }

        .bg-orb {
            position: absolute;
            border-radius: 999px;
            filter: blur(45px);
            opacity: 0.65;
            mix-blend-mode: screen;
            will-change: transform;
        }

        .orb-1 {
            width: 520px;
            height: 520px;
            background: radial-gradient(circle, rgba(99,102,241,0.4) 0, transparent 60%);
            top: -160px;
            left: -120px;
            animation: orbFloat1 18s ease-in-out infinite alternate;
        }

        .orb-2 {
            width: 420px;
            height: 420px;
            background: radial-gradient(circle, rgba(16,185,129,0.35) 0, transparent 60%);
            bottom: -140px;
            right: -100px;
            animation: orbFloat2 16s ease-in-out infinite alternate;
        }

        .orb-3 {
            width: 380px;
            height: 380px;
            background: radial-gradient(circle, rgba(244,114,182,0.3) 0, transparent 55%);
            top: 40%;
            left: 40%;
            animation: orbFloat3 22s ease-in-out infinite alternate;
        }

        @keyframes orbFloat1 {
            from { transform: translate3d(0,0,0) scale(1); }
            to   { transform: translate3d(40px,20px,0) scale(1.1); }
        }
        @keyframes orbFloat2 {
            from { transform: translate3d(0,0,0) scale(1); }
            to   { transform: translate3d(-35px,-10px,0) scale(1.05); }
        }
        @keyframes orbFloat3 {
            from { transform: translate3d(0,0,0) scale(1); }
            to   { transform: translate3d(-20px,30px,0) scale(1.15); }
        }

        .float-icon {
            position: absolute;
            font-size: 24px;
            opacity: .8;
            animation: floatIcon 18s ease-in-out infinite;
        }
        .float-icon:nth-child(4) { top: 12%; left: 8%; animation-delay: -4s; }
        .float-icon:nth-child(5) { top: 70%; left: 18%; animation-delay: -9s; }
        .float-icon:nth-child(6) { top: 18%; right: 12%; animation-delay: -13s; }
        .float-icon:nth-child(7) { top: 58%; right: 6%; animation-delay: -18s; }

        @keyframes floatIcon {
            0%   { transform: translate3d(0,0,0) rotate(0deg); }
            50%  { transform: translate3d(12px,-16px,0) rotate(8deg); }
            100% { transform: translate3d(-10px,8px,0) rotate(-6deg); }
        }

        /* Snowflakes */
        .snow {
            position: fixed;
            top: -16px;
            color: #fff;
            font-size: 12px;
            opacity: .7;
            animation: snowFall linear infinite;
            pointer-events: none;
            z-index: 0;
        }
        @keyframes snowFall {
            0%   { transform: translate3d(0,-10px,0); opacity: 0; }
            10%  { opacity: .9; }
            100% { transform: translate3d(0,105vh,0); opacity: 0; }
        }

        .container {
            position: relative;
            z-index: 1;
            max-width: 500px;
            margin: 0 auto;
            padding: 16px 16px 0;
        }

        /* --- HEADER --- */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 14px;
        }

        .user-profile {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .avatar {
            width: 40px;
            height: 40px;
            border-radius: 14px;
            background: conic-gradient(from 180deg, #F97316, #FACC15, #22C55E, #3B82F6, #A855F7, #F97316);
            display:flex;align-items:center;justify-content:center;
            color:#020617;font-weight:800;font-size:18px;
            box-shadow:0 10px 32px rgba(15,23,42,.9);
        }
        .user-info h3 { font-size: 14px; font-weight: 600; }
        .user-info span { font-size: 11px; color: var(--text-secondary); }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .btn-urgent {
            padding: 7px 13px;
            border-radius: 999px;
            border: 1px solid rgba(255,255,255,.35);
            background: linear-gradient(120deg, rgba(248,250,252,.18), rgba(147,197,253,.2));
            font-size: 11px;
            font-weight: 600;
            color: #fff;
            cursor: pointer;
            box-shadow: 0 0 22px rgba(147,197,253,.7);
        }
        .btn-icon-round {
            width: 40px;
            height: 40px;
            border-radius: 999px;
            background: rgba(15,23,42,.9);
            border: 1px solid var(--glass-border);
            display:flex;align-items:center;justify-content:center;
            cursor:pointer;
            position:relative;
            font-size:19px;
        }
        .cart-badge{
            position:absolute;
            top:3px;right:3px;
            width:10px;height:10px;
            border-radius:50%;
            background:var(--danger);
            display:none;
        }

        .ny-banner {
            border-radius: 16px;
            padding: 8px 12px;
            background: linear-gradient(90deg, rgba(248,250,252,0.16), rgba(59,130,246,0.16));
            border: 1px solid rgba(248,250,252,0.25);
            font-size: 11px;
            display:flex;align-items:center;gap:8px;
            margin-bottom: 10px;
        }
        .ny-banner span:first-child { font-size: 16px; }
        .ny-banner strong { color: var(--accent-gold); }

        /* --- COMMON SECTIONS --- */
        .hero-title {
            font-size: 26px;
            font-weight: 800;
            line-height: 1.25;
            margin-bottom: 10px;
            background: linear-gradient(115deg,#f9fafb,#e5e7eb,#a5b4fc);
            -webkit-background-clip:text;
            -webkit-text-fill-color:transparent;
        }
        .hero-subtitle {
            font-size: 13px;
            color: var(--text-secondary);
            margin-bottom: 16px;
        }

        .stats-row {
            display:grid;
            grid-template-columns:1fr 1fr 1.3fr;
            gap:10px;
            margin-bottom:16px;
        }
        .stat-card {
            background: var(--glass-soft);
            border-radius: 14px;
            padding: 10px 11px;
            border: 1px solid var(--glass-border);
            backdrop-filter: blur(16px);
        }
        .stat-label { font-size: 11px; color: var(--text-secondary); margin-bottom: 4px; }
        .stat-value { font-size: 14px; font-weight: 700; }
        .stat-value.green{ color:var(--success); }
        .stat-value.cyan{ color:var(--accent-cyan);}
        .stat-value.gold{ color:var(--accent-gold); }

        /* TABS WORKS / APPS */
        .tabs-switcher{
            display:flex;position:relative;
            background:rgba(15,23,42,0.96);
            border-radius:999px;
            padding:4px;
            border:1px solid rgba(148,163,255,.4);
            margin-bottom:14px;
        }
        .tab-indicator{
            position:absolute;
            top:4px;left:4px;
            width:calc(50% - 4px);
            height:calc(100% - 8px);
            border-radius:999px;
            background:var(--primary-gradient);
            box-shadow:0 8px 25px var(--primary-soft);
            transition:transform .28s cubic-bezier(.4,0,.2,1);
            z-index:1;
        }
        .tab-btn{
            flex:1;
            text-align:center;
            font-size:13px;
            padding:7px 0;
            font-weight:600;
            color:var(--text-secondary);
            z-index:2;
            cursor:pointer;
        }
        .tab-btn.active{color:#fff;}

        .banner{
            background:linear-gradient(135deg,rgba(56,189,248,.22),rgba(59,130,246,.18));
            border-radius:18px;
            border:1px solid rgba(191,219,254,.6);
            padding:14px 14px;
            display:flex;align-items:center;justify-content:space-between;
            margin-bottom:14px;cursor:pointer;
            position:relative;overflow:hidden;
        }
        .banner-content{max-width:75%;}
        .banner h4{font-size:10px;letter-spacing:1px;text-transform:uppercase;color:rgba(248,250,252,.8);margin-bottom:4px;}
        .banner h3{font-size:15px;font-weight:700;margin-bottom:3px;}
        .banner p{font-size:11px;color:rgba(226,232,240,.9);}
        .banner-light{
            width:42px;height:42px;
            border-radius:50%;
            background:radial-gradient(circle,#FACC15,#F97316);
            color:#111827;font-size:22px;
            display:flex;align-items:center;justify-content:center;
            box-shadow:0 0 26px rgba(250,204,21,.9);
        }

        .filters{
            display:flex;gap:8px;overflow-x:auto;
            margin-bottom:12px;padding-bottom:4px;
        }
        .filter-pill{
            padding:6px 14px;
            border-radius:999px;
            background:rgba(15,23,42,.96);
            border:1px solid var(--glass-border);
            font-size:11px;color:var(--text-secondary);
            white-space:nowrap;cursor:pointer;
        }
        .filter-pill.active{
            background:var(--primary-gradient);
            color:#fff;border-color:transparent;
        }

        .grid{
            display:grid;
            grid-template-columns:1fr 1fr;
            gap:10px;
            margin-bottom:20px;
        }
        .product-card{
            background:rgba(15,23,42,0.98);
            border-radius:16px;
            border:1px solid rgba(148,163,255,.25);
            padding:11px;
            position:relative;
            cursor:pointer;
            transition:transform .15s, box-shadow .15s, border-color .15s;
        }
        .product-card:hover{
            transform:translateY(-2px);
            box-shadow:0 10px 25px rgba(15,23,42,.8);
            border-color:rgba(148,163,255,.9);
        }
        .card-icon-box{
            width:30px;height:30px;border-radius:10px;
            background:rgba(15,23,42,.9);
            display:flex;align-items:center;justify-content:center;
            margin-bottom:8px;font-size:16px;
        }
        .product-title{font-size:13px;font-weight:600;margin-bottom:2px;}
        .product-desc{font-size:10px;color:var(--text-secondary);margin-bottom:10px;}
        .product-footer{display:flex;justify-content:space-between;align-items:center;}
        .price{font-size:14px;font-weight:700;color:var(--accent-cyan);}
        .time{font-size:10px;color:var(--text-secondary);}
        .add-btn{
            position:absolute;top:7px;right:7px;
            width:22px;height:22px;border-radius:999px;
            background:rgba(15,23,42,.9);
            border:1px solid rgba(148,163,255,.8);
            display:flex;align-items:center;justify-content:center;
            font-size:16px;cursor:pointer;
        }

        /* --- PRODUCT MODAL --- */
        .modal-wrap{
            position:fixed;inset:0;
            background:rgba(15,23,42,.9);
            backdrop-filter:blur(18px);
            -webkit-backdrop-filter:blur(18px);
            display:flex;justify-content:center;align-items:flex-end;
            z-index:40;
        }
        .modal{
            width:100%;max-width:480px;
            background:rgba(15,23,42,0.98);
            border-radius:24px 24px 0 0;
            border-top:1px solid rgba(148,163,255,.6);
            padding:14px 16px 22px;
            box-shadow:0 -16px 40px rgba(0,0,0,.9);
        }
        .modal-header{
            display:flex;justify-content:space-between;align-items:center;
            margin-bottom:8px;
        }
        .modal-title{font-size:16px;font-weight:700;}
        .modal-close{font-size:24px;color:var(--text-secondary);cursor:pointer;}

        .deadline-row{display:flex;gap:8px;margin:10px 0 8px;}
        .deadline-option{
            flex:1;background:rgba(15,23,42,.96);
            border-radius:12px;padding:8px;
            border:1px solid var(--glass-border);
            cursor:pointer;font-size:11px;
        }
        .deadline-option.active{
            border-color:var(--accent-cyan);
            box-shadow:0 0 20px rgba(56,189,248,.6);
        }
        .deadline-label{font-weight:600;}
        .deadline-price{margin-top:3px;color:var(--accent-cyan);font-size:13px;}
        .modal-desc{font-size:13px;color:var(--text-secondary);margin-top:4px;}

        .modal-footer{
            margin-top:12px;
            display:flex;justify-content:space-between;align-items:center;
        }
        .modal-price{font-size:20px;font-weight:700;color:var(--accent-cyan);}
        .btn-main{
            padding:10px 18px;
            border-radius:999px;
            border:none;
            background:var(--primary-gradient);
            color:#fff;font-weight:600;
            cursor:pointer;
        }

        /* --- COMMON INPUTS --- */
        input, textarea {
            width: 100%;
            background: rgba(15,23,42,.95);
            border-radius: 12px;
            border: 1px solid var(--glass-border);
            color: var(--text-main);
            font-size: 14px;
            padding: 12px;
            outline: none;
        }
        input::placeholder, textarea::placeholder { color: var(--text-secondary); }
        input:focus, textarea:focus { border-color: var(--accent-purple); }

        /* --- ORDER CARDS --- */
        .order-card{
            background:rgba(15,23,42,.96);
            border-radius:16px;
            border:1px solid var(--glass-border);
            padding:14px;
            margin-bottom:10px;
        }

        /* --- CHAT --- */
        #view-support{
            min-height:calc(100vh - 96px);
        }
        .chat-wrapper{
            background:rgba(15,23,42,.95);
            border-radius:18px;
            border:1px solid var(--glass-border);
            padding:10px 10px 12px;
            margin-top:8px;
            display:flex;
            flex-direction:column;
            height:calc(100vh - 160px); /* –ø–æ—á—Ç–∏ –≤–µ—Å—å —ç–∫—Ä–∞–Ω */
        }
        .chat-header{
            display:flex;justify-content:space-between;align-items:center;
            margin-bottom:6px;
        }
        .chat-header-left{
            display:flex;align-items:center;gap:8px;
        }
        .status-dot{
            width:8px;height:8px;border-radius:50%;background:var(--success);
            box-shadow:0 0 8px rgba(34,197,94,.9);
        }
        .chat-header-title{font-size:13px;font-weight:600;}
        .chat-header-sub{font-size:11px;color:var(--text-secondary);}

        #chat-history{
            flex:1;
            overflow-y:auto;
            padding:6px 2px 4px;
        }
        .msg{
            max-width:78%;
            padding:9px 11px;
            border-radius:14px;
            margin-bottom:6px;
            font-size:13px;
            line-height:1.35;
            word-wrap:break-word;
        }
        .msg-user{
            margin-left:auto;
            background:var(--primary-gradient);
            color:#fff;
            border-bottom-right-radius:4px;
        }
        .msg-admin{
            margin-right:auto;
            background:rgba(15,23,42,1);
            border:1px solid var(--glass-border);
            border-bottom-left-radius:4px;
        }
        .msg-time{
            display:block;
            margin-top:3px;
            font-size:10px;
            opacity:.6;
        }

        .chat-input-row{
            margin-top:6px;
            display:flex;
            gap:6px;
            align-items:flex-end;
        }
        .chat-input-row textarea{
            flex:1;
            resize:none;
            min-height:36px;
            max-height:72px;
            border-radius:16px;
            padding:9px 10px;
        }
        .chat-btn{
            width:40px;height:40px;
            border-radius:14px;
            border:none;
            background:var(--glass-soft);
            color:#fff;font-size:19px;
            display:flex;align-items:center;justify-content:center;
            cursor:pointer;
        }
        .chat-btn.send{background:var(--primary-gradient);}

        /* --- NAV --- */
        .bottom-nav{
            position:fixed;
            left:50%;transform:translateX(-50%);
            bottom:16px;
            width:92%;max-width:420px;
            background:rgba(3,7,18,.96);
            border-radius:20px;
            border:1px solid var(--glass-border);
            display:flex;justify-content:space-around;
            padding:9px 14px;
            z-index:30;
            backdrop-filter:blur(20px);
        }
        .nav-item{
            display:flex;flex-direction:column;
            align-items:center;gap:2px;
            font-size:10px;color:var(--text-secondary);
            opacity:.6;cursor:pointer;
        }
        .nav-item svg{width:20px;height:20px;fill:currentColor;}
        .nav-item.active{opacity:1;color:#fff;}

        .hidden { display:none !important; }
    </style>
</head>
<body>
<div class="bg-layer" id="bg-layer">
    <div class="bg-orb orb-1"></div>
    <div class="bg-orb orb-2"></div>
    <div class="bg-orb orb-3"></div>
    <div class="float-icon">üéì</div>
    <div class="float-icon">üíª</div>
    <div class="float-icon">‚ùÑÔ∏è</div>
    <div class="float-icon">üìö</div>
</div>

<!-- snowflakes -->
<script>
    (function snow(){
        for(let i=0;i<28;i++){
            const s=document.createElement('div');
            s.className='snow';
            s.textContent='‚ùÑ';
            s.style.left=Math.random()*100+'%';
            const dur=10+Math.random()*12;
            s.style.animationDuration=dur+'s';
            s.style.animationDelay=(-dur*Math.random())+'s';
            document.body.appendChild(s);
        }
    })();
</script>

<!-- file inputs -->
<input type="file" id="file-input" class="hidden" accept="image/*,.pdf,.doc,.docx,.txt,.zip,.rar">
<input type="file" id="custom-file-input" class="hidden" accept="image/*,.pdf,.doc,.docx,.txt,.zip,.rar">
<input type="file" id="order-file-input" class="hidden" accept="image/*,.pdf,.doc,.docx,.txt,.zip,.rar">

<div class="container">
    <!-- HEADER -->
    <div class="header">
        <div class="user-profile">
            <div class="avatar" id="avatar">S</div>
            <div class="user-info">
                <h3 id="username-display">student</h3>
                <span>ID: <span id="user-id-display">...</span></span>
            </div>
        </div>
        <div class="header-actions">
            <div class="btn-urgent" onclick="openTab('custom')">–°—Ä–æ—á–Ω—ã–π –∑–∞–∫–∞–∑ üéÑ</div>
            <div class="btn-icon-round" onclick="openTab('cart')">
                üõí
                <div class="cart-badge" id="cart-badge"></div>
            </div>
        </div>
    </div>

    <div class="ny-banner">
        <span>üéÅ</span>
        <span>–ù–æ–≤–æ–≥–æ–¥–Ω—è—è –∞–∫—Ü–∏—è: –ø—Ä–æ–º–æ–∫–æ–¥ <strong>NEWYEAR20</strong> ‚Äî —Å–∫–∏–¥–∫–∞ 20% –Ω–∞ –∑–∞–∫–∞–∑.</span>
    </div>

    <!-- VIEW: STORE -->
    <div id="view-store">
        <div class="hero-title">–£–º–Ω—ã–π –º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å<br>—Ä–∞–±–æ—Ç –∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π</div>
        <div class="hero-subtitle">–õ–∞–±–æ—Ä–∞—Ç–æ—Ä–Ω—ã–µ, –∫—É—Ä—Å–æ–≤—ã–µ, –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –∏ –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–µ –∑–∞–∫–∞–∑—ã —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π 24/7.</div>

        <div class="stats-row">
            <div class="stat-card"><div class="stat-label">–°–¥–µ–ª–∞–Ω–æ</div><div class="stat-value green">120+</div></div>
            <div class="stat-card"><div class="stat-label">–°—Ä–µ–¥–Ω–∏–π —Å—Ä–æ–∫</div><div class="stat-value cyan">2.1 –¥–Ω—è</div></div>
            <div class="stat-card"><div class="stat-label">–û–Ω–ª–∞–π–Ω</div><div class="stat-value gold">2 –º–µ–Ω–µ–¥–∂–µ—Ä–∞</div></div>
        </div>

        <div class="tabs-switcher">
            <div class="tab-indicator" id="tab-indicator"></div>
            <div class="tab-btn active" id="tab-btn-labs" onclick="switchStoreTab('labs')">–†–∞–±–æ—Ç—ã</div>
            <div class="tab-btn" id="tab-btn-apps" onclick="switchStoreTab('apps')">–ü—Ä–∏–ª–æ–∂–µ–Ω–∏—è</div>
        </div>

        <div class="banner" onclick="openTab('custom')">
            <div class="banner-content">
                <h4>–ù–µ –Ω–∞—à–ª–∏ –Ω—É–∂–Ω—É—é —Ä–∞–±–æ—Ç—É?</h4>
                <h3>–°–æ–±–µ—Ä—ë–º –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–æ–µ –∑–∞–¥–∞–Ω–∏–µ</h3>
                <p>–ü—Ä–∏–∫—Ä–µ–ø–∏—Ç–µ –∑–∞–¥–∞–Ω–∏–µ, –≤—ã–±–µ—Ä–∏—Ç–µ —Å—Ä–æ–∫ ‚Äî –±–æ—Ç –ø–µ—Ä–µ–¥–∞—Å—Ç –≤—Å—ë –º–µ–Ω–µ–¥–∂–µ—Ä—É.</p>
            </div>
            <div class="banner-light">‚ö°</div>
        </div>

        <div class="filters">
            <div class="filter-pill active" data-filter="all" onclick="setFilter('all')">–í—Å–µ</div>
            <div class="filter-pill" data-filter="–ò–Ω—Ñ–∞" onclick="setFilter('–ò–Ω—Ñ–∞')">–ò–Ω—Ñ–∞</div>
            <div class="filter-pill" data-filter="–û–ü" onclick="setFilter('–û–ü')">–û–ü</div>
            <div class="filter-pill" data-filter="–î–∏—Å–∫—Ä–µ—Ç–∫–∞" onclick="setFilter('–î–∏—Å–∫—Ä–µ—Ç–∫–∞')">–î–∏—Å–∫—Ä–µ—Ç–∫–∞</div>
            <div class="filter-pill" data-filter="–î—Ä—É–≥–æ–µ" onclick="setFilter('–î—Ä—É–≥–æ–µ')">–î—Ä—É–≥–æ–µ</div>
        </div>

        <div id="grid-labs" class="grid"></div>
        <div id="grid-apps" class="grid hidden"></div>
    </div>

    <!-- VIEW: CUSTOM -->
    <div id="view-custom" class="hidden">
        <div class="hero-title">–ò–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–π –∑–∞–∫–∞–∑</div>
        <p class="hero-subtitle">–û—Ç 350 ‚ÇΩ ¬∑ —Ü–µ–Ω–∞ –¥–æ–≥–æ–≤–æ—Ä–Ω–∞—è. –û–ø–∏—à–∏—Ç–µ –∑–∞–¥–∞–Ω–∏–µ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –ø–æ–¥—Ä–æ–±–Ω–æ.</p>

        <div class="stat-card" style="margin-bottom:14px;">
            <input id="custom-name" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —Ä–∞–±–æ—Ç—ã / –ø—Ä–µ–¥–º–µ—Ç">
            <div style="height:1px;background:var(--glass-border);margin:8px 0;"></div>
            <textarea id="custom-desc" placeholder="–¢–µ–∫—Å—Ç –∑–∞–¥–∞–Ω–∏—è, —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è, —Å—Å—ã–ª–∫–∏..."></textarea>
        </div>

        <div class="banner" onclick="document.getElementById('custom-file-input').click()" style="margin-bottom:16px;">
            <div class="banner-content">
                <h3>–ü—Ä–∏–∫—Ä–µ–ø–∏—Ç—å —Ñ–∞–π–ª</h3>
                <p id="custom-file-label">–ú–µ—Ç–æ–¥–∏—á–∫–∞, –ø—Ä–∏–º–µ—Ä, –∑–∞–¥–∞–Ω–∏–µ (–¥–æ 10 –ú–ë)</p>
            </div>
            <div class="banner-light" style="background:radial-gradient(circle,#E5E7EB,#9CA3AF);color:#111827;">üìé</div>
        </div>

        <button class="btn-main" onclick="submitCustomOrder()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–∞ –æ—Ü–µ–Ω–∫—É</button>
    </div>

    <!-- VIEW: CART -->
    <div id="view-cart" class="hidden">
        <div class="hero-title">–ö–æ—Ä–∑–∏–Ω–∞</div>
        <div id="cart-items"></div>
        <div id="cart-footer" class="hidden">
            <div class="stat-card" style="margin-top:14px;">
                <div style="display:flex;gap:8px;">
                    <input id="promo-input" placeholder="–ü—Ä–æ–º–æ–∫–æ–¥">
                    <button onclick="checkPromo()" style="border-radius:12px;border:1px solid var(--glass-border);background:rgba(15,23,42,.95);color:white;padding:0 14px;">OK</button>
                </div>
                <div id="promo-result" style="margin-top:6px;font-size:12px;"></div>
            </div>
            <div style="display:flex;justify-content:space-between;align-items:center;margin:18px 0 10px;">
                <span style="font-size:14px;color:var(--text-secondary)">–ò—Ç–æ–≥–æ:</span>
                <span id="cart-total" style="font-size:20px;font-weight:700;">0 ‚ÇΩ</span>
            </div>
            <button class="btn-main" onclick="checkout()">–û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑</button>
        </div>
    </div>

    <!-- VIEW: ORDERS -->
    <div id="view-orders" class="hidden">
        <div class="hero-title">–ú–æ–∏ –∑–∞–∫–∞–∑—ã</div>
        <div id="orders-list"></div>
    </div>

    <!-- VIEW: SUPPORT -->
    <div id="view-support" class="hidden">
        <div class="hero-title">–ü–æ–¥–¥–µ—Ä–∂–∫–∞</div>
        <div class="chat-wrapper">
            <div class="chat-header">
                <div class="chat-header-left">
                    <div class="status-dot"></div>
                    <div>
                        <div class="chat-header-title">–ú–µ–Ω–µ–¥–∂–µ—Ä –æ–Ω–ª–∞–π–Ω</div>
                        <div class="chat-header-sub">–û—Ç–≤–µ—á–∞–µ–º –≤ —Ç–µ—á–µ–Ω–∏–µ 5‚Äì15 –º–∏–Ω—É—Ç</div>
                    </div>
                </div>
                <div style="font-size:12px;color:var(--text-secondary);">–ß–∞—Ç LabX</div>
            </div>
            <div id="chat-history"></div>
            <div class="chat-input-row">
                <button class="chat-btn" onclick="document.getElementById('file-input').click()">+</button>
                <textarea id="chat-input" placeholder="–í–∞—à –≤–æ–ø—Ä–æ—Å..."></textarea>
                <button class="chat-btn send" onclick="sendMessage()">‚û§</button>
            </div>
        </div>
    </div>
</div>

<!-- PRODUCT MODAL -->
<div id="product-modal-wrap" class="hidden">
    <div class="modal-wrap" onclick="closeProductModal(event)">
        <div class="modal" onclick="event.stopPropagation()">
            <div class="modal-header">
                <div class="modal-title" id="modal-title"></div>
                <div class="modal-close" onclick="closeProductModal(event)">√ó</div>
            </div>
            <div id="modal-subtitle" style="font-size:12px;color:var(--text-secondary);margin-bottom:4px;"></div>
            <div class="deadline-row">
                <div class="deadline-option active" data-key="slow" onclick="selectDeadline('slow')">
                    <div class="deadline-label">5‚Äì7 –¥–Ω–µ–π</div>
                    <div class="deadline-price" id="price-slow"></div>
                </div>
                <div class="deadline-option" data-key="medium" onclick="selectDeadline('medium')">
                    <div class="deadline-label">2‚Äì4 –¥–Ω—è</div>
                    <div class="deadline-price" id="price-medium"></div>
                </div>
                <div class="deadline-option" data-key="fast" onclick="selectDeadline('fast')">
                    <div class="deadline-label">1 –¥–µ–Ω—å</div>
                    <div class="deadline-price" id="price-fast"></div>
                </div>
            </div>
            <div class="modal-desc" id="modal-desc"></div>
            <div class="modal-footer">
                <div class="modal-price" id="modal-price"></div>
                <button class="btn-main" onclick="addFromModal()">–î–æ–±–∞–≤–∏—Ç—å</button>
            </div>
        </div>
    </div>
</div>

<!-- BOTTOM NAV -->
<div class="bottom-nav">
    <div class="nav-item active" id="nav-store" onclick="openTab('store')">
        <svg viewBox="0 0 24 24"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></svg>
        <span>–ì–ª–∞–≤–Ω–∞—è</span>
    </div>
    <div class="nav-item" id="nav-orders" onclick="openTab('orders')">
        <svg viewBox="0 0 24 24"><path d="M19 3H5C3.9 3 3 3.9 3 5v14l4-4h12c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2z"/></svg>
        <span>–ó–∞–∫–∞–∑—ã</span>
    </div>
    <div class="nav-item" id="nav-custom" onclick="openTab('custom')">
        <svg viewBox="0 0 24 24"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34a.996.996 0 0 0-1.41 1.41l2.34 2.34c.39.39 1.02.39 1.41 0z"/></svg>
        <span>–ó–∞–∫–∞–∑</span>
    </div>
    <div class="nav-item" id="nav-support" onclick="openTab('support')">
        <svg viewBox="0 0 24 24"><path d="M20 2H4C2.9 2 2 2.9 2 4v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2z"/></svg>
        <span>–ß–∞—Ç</span>
    </div>
</div>

<script>
const tg = window.Telegram.WebApp;
tg.expand(); tg.ready();

const urlParams = new URLSearchParams(window.location.search);
let userId = urlParams.get('uid') ? parseInt(urlParams.get('uid')) : (tg.initDataUnsafe.user?.id || 0);
const username = urlParams.get('user') || tg.initDataUnsafe.user?.username || 'Student';

document.getElementById('user-id-display').textContent = userId;
document.getElementById('username-display').textContent = username;
document.getElementById('avatar').textContent = (username[0] || 'S').toUpperCase();

let cart = [];
let discount = 0;
let customFileUrl = '';
let chatInterval = null;
let isProcessing = false;

/* PRODUCTS (–¥–æ–±–∞–≤–ª—è–µ—à—å —Ç—É—Ç) */
const products = [
    {
        id:'lab_algo1',
        type:'lab',
        title:'–õ–∞–±–∞ –ø–æ –æ–ø ‚Ññ3',
        subtitle:'–° ¬∑ –ë–ª–æ–∫-—Å—Ö–µ–º–∞',
        basePrice:500,
        desc:'–†–µ—à–µ–Ω–∏–µ –ª–∞–±–æ—Ä–∞—Ç–æ—Ä–Ω–æ–π –ø–æ –±–∞–∑–æ–≤—ã–º –∞–ª–≥–æ—Ä–∏—Ç–º–∞–º —Å –ø–æ–¥—Ä–æ–±–Ω—ã–º –æ—Ç—á—ë—Ç–æ–º –∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è–º–∏ –∫ –∫–æ–¥—É.',
        tags:['–û–ü'],
        icon:'üî¢',
        grid:'labs'
    },
    {
        id:'lab_algo2',
        type:'lab',
        title:'–õ–∞–±–∞ –ø–æ –æ–ø ‚Ññ4',
        subtitle:'–° ¬∑ –ë–ª–æ–∫-—Å—Ö–µ–º–∞',
        basePrice:650,
        desc:'–†–µ—à–µ–Ω–∏–µ –ª–∞–±–æ—Ä–∞—Ç–æ—Ä–Ω–æ–π –ø–æ –±–∞–∑–æ–≤—ã–º –∞–ª–≥–æ—Ä–∏—Ç–º–∞–º —Å –ø–æ–¥—Ä–æ–±–Ω—ã–º –æ—Ç—á—ë—Ç–æ–º –∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è–º–∏ –∫ –∫–æ–¥—É.',
        tags:['–û–ü'],
        icon:'üî¢',
        grid:'labs'
    },
    {
        id:'lab_algo3',
        type:'lab',
        title:'–õ–∞–±–∞ –ø–æ –æ–ø ‚Ññ5',
        subtitle:'–° ¬∑ –ë–ª–æ–∫-—Å—Ö–µ–º–∞',
        basePrice:999,
        desc:'–†–µ—à–µ–Ω–∏–µ –ª–∞–±–æ—Ä–∞—Ç–æ—Ä–Ω–æ–π –ø–æ –±–∞–∑–æ–≤—ã–º –∞–ª–≥–æ—Ä–∏—Ç–º–∞–º —Å –ø–æ–¥—Ä–æ–±–Ω—ã–º –æ—Ç—á—ë—Ç–æ–º –∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è–º–∏ –∫ –∫–æ–¥—É.',
        tags:['–û–ü'],
        icon:'üî¢',
        grid:'labs'
    },
    {
        id:'lab_infa1',
        type:'lab',
        title:'–õ–∞–±–∞ –ø–æ –∏–Ω—Ñ–µ ‚Ññ5',
        subtitle:'–ü–æ–¥—Ä–æ–±–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ',
        basePrice:500,
        desc:'–†–µ—à–µ–Ω–∏–µ –ª–∞–±–æ—Ä–∞—Ç–æ—Ä–Ω–æ–π –ø–æ –±–∞–∑–æ–≤—ã–º –∞–ª–≥–æ—Ä–∏—Ç–º–∞–º —Å –ø–æ–¥—Ä–æ–±–Ω—ã–º –æ—Ç—á—ë—Ç–æ–º –∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è–º–∏ –∫ –∫–æ–¥—É.',
        tags:['–ò–Ω—Ñ–∞'],
        icon:'üî¢',
        grid:'labs'
    },
    {
        id:'lab_infa2',
        type:'lab',
        title:'–õ–∞–±–∞ –ø–æ –∏–Ω—Ñ–µ ‚Ññ6',
        subtitle:'–ü–æ–¥—Ä–æ–±–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ',
        basePrice:500,
        desc:'–†–µ—à–µ–Ω–∏–µ –ª–∞–±–æ—Ä–∞—Ç–æ—Ä–Ω–æ–π –ø–æ –±–∞–∑–æ–≤—ã–º –∞–ª–≥–æ—Ä–∏—Ç–º–∞–º —Å –ø–æ–¥—Ä–æ–±–Ω—ã–º –æ—Ç—á—ë—Ç–æ–º –∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è–º–∏ –∫ –∫–æ–¥—É.',
        tags:['–ò–Ω—Ñ–∞'],
        icon:'üî¢',
        grid:'labs'
    },
    {
        id:'lab_infa3',
        type:'lab',
        title:'–õ–∞–±–∞ –ø–æ –∏–Ω—Ñ–µ ‚Ññ7',
        subtitle:'–ü–æ–¥—Ä–æ–±–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ',
        basePrice:500,
        desc:'–†–µ—à–µ–Ω–∏–µ –ª–∞–±–æ—Ä–∞—Ç–æ—Ä–Ω–æ–π –ø–æ –±–∞–∑–æ–≤—ã–º –∞–ª–≥–æ—Ä–∏—Ç–º–∞–º —Å –ø–æ–¥—Ä–æ–±–Ω—ã–º –æ—Ç—á—ë—Ç–æ–º –∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è–º–∏ –∫ –∫–æ–¥—É.',
        tags:['–ò–Ω—Ñ–∞'],
        icon:'üî¢',
        grid:'labs'
    },
    {
        id:'lab_infa_referat',
        type:'lab',
        title:'–†–µ—Ñ–µ—Ä–∞—Ç',
        subtitle:'–û—Ç—Å—á–µ—Ç ¬∑ –¢–µ–∫—Å—Ç',
        basePrice:750,
        desc:'–ü–æ–¥—Ä–æ–±–Ω—ã–π —Ä–µ—Ñ–µ—Ä–∞—Ç, —Å –∫—Ä–∞—Å–∏–≤–æ - –æ—Ñ–æ—Ä–º–ª–µ–Ω–Ω—ã–º —Ç–µ–∫—Å—Ç–æ–º, –ø–æ –≥–æ—Å—Ç—É',
        tags:['–ò–Ω—Ñ–∞'],
        icon:'üî¢',
        grid:'labs'
    },
    {
        id:'lab_discrete',
        type:'lab',
        title:'–î–∏—Å–∫—Ä–µ—Ç–∫–∞ ¬∑ –≥—Ä–∞—Ñ—ã',
        subtitle:'C++ ¬∑ –ì—Ä–∞—Ñ—ã',
        basePrice:550,
        desc:'–†–µ–∞–ª–∏–∑–∞—Ü–∏—è –∏ —Ä–∞–∑–±–æ—Ä –∑–∞–¥–∞—á –ø–æ —Ç–µ–æ—Ä–∏–∏ –≥—Ä–∞—Ñ–æ–≤: –æ–±—Ö–æ–¥—ã, –∫—Ä–∞—Ç—á–∞–π—à–∏–µ –ø—É—Ç–∏, –æ—Å—Ç–æ–≤–Ω—ã–µ –¥–µ—Ä–µ–≤—å—è.',
        tags:['–î–∏—Å–∫—Ä–µ—Ç–∫–∞'],
        icon:'üìä',
        grid:'labs'
    },
    {
        id:'lab_db',
        type:'lab',
        title:'–õ–∞–±–∞ –ø–æ –ë–î',
        subtitle:'SQL ¬∑ Postgres',
        basePrice:520,
        desc:'–ü—Ä–æ–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö, SQL-–∑–∞–ø—Ä–æ—Å—ã, —Å–∫—Ä–∏–ø—Ç—ã –∏ –æ—Ç—á—ë—Ç. –ü–æ–ª–Ω–æ—Å—Ç—å—é –ø–æ–¥ –≤–∞—à –í–£–ó.',
        tags:['–ò–Ω—Ñ–∞','–î—Ä—É–≥–æ–µ'],
        icon:'üóÑ',
        grid:'labs'
    },
    {
        id:'lab_math',
        type:'lab',
        title:'–ú–∞—Ç–∞–Ω ¬∑ –∏–Ω—Ç–µ–≥—Ä–∞–ª—ã',
        subtitle:'–†–µ—à–µ–Ω–∏–µ –∑–∞–¥–∞—á',
        basePrice:450,
        desc:'–ü–æ–¥—Ä–æ–±–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ —Ç–∏–ø–æ–≤—ã—Ö –∑–∞–¥–∞—á –ø–æ –∏–Ω—Ç–µ–≥—Ä–∞–ª–∞–º —Å –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ–º –ø–æ–¥ –ì–û–°–¢.',
        tags:['–î—Ä—É–≥–æ–µ'],
        icon:'üìê',
        grid:'labs'
    },
    {
        id:'app_course',
        type:'app',
        title:'–ö—É—Ä—Å–æ–≤–∞—è –ø–æ –ë–î',
        subtitle:'–†–∞–∑—Ä–∞–±–æ—Ç–∫–∞ –ø–æ–¥ –∫–ª—é—á',
        basePrice:2500,
        desc:'–ü–æ–ª–Ω–∞—è –∫—É—Ä—Å–æ–≤–∞—è: –ø–æ—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–¥–∞—á–∏, ER-–¥–∏–∞–≥—Ä–∞–º–º—ã, SQL-—Å–∫—Ä–∏–ø—Ç—ã, –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –∏ –ø–æ—è—Å–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∑–∞–ø–∏—Å–∫–∞.',
        tags:['–ò–Ω—Ñ–∞','–î—Ä—É–≥–æ–µ'],
        icon:'üíæ',
        grid:'apps'
    },
    {
        id:'app_tg_bot',
        type:'app',
        title:'Telegram-–±–æ—Ç',
        subtitle:'Python ¬∑ Aiogram',
        basePrice:3000,
        desc:'–†–∞–∑—Ä–∞–±–æ—Ç–∫–∞ Telegram-–±–æ—Ç–∞ –ª—é–±–æ–π —Å–ª–æ–∂–Ω–æ—Å—Ç–∏: inline, –º–µ–Ω—é, –æ–ø–ª–∞—Ç–∞, –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏.',
        tags:['–ò–Ω—Ñ–∞','–û–ü','–î—Ä—É–≥–æ–µ'],
        icon:'ü§ñ',
        grid:'apps'
    },
    {
        id:'app_DocGen',
        type:'app',
        title:'DocGen',
        subtitle:'Python ¬∑ Aiogram',
        basePrice:999,
        desc:'DocGen –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–æ–≤ word',
        tags:['–ò–Ω—Ñ–∞','–û–ü','–î—Ä—É–≥–æ–µ'],
        icon:'ü§ñ',
        grid:'apps'
    },
    {
        id:'app_TubelQ',
        type:'app',
        title:'TubelQ',
        subtitle:'Python ¬∑ Aiogram',
        basePrice:999,
        desc:'–ü—Ä–∏–ª–æ–∂–µ–Ω–∏—è –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –≤–∏–¥–µ–æ YouTube',
        tags:['–ò–Ω—Ñ–∞','–û–ü','–î—Ä—É–≥–æ–µ'],
        icon:'ü§ñ',
        grid:'apps'
    }
];

const priceModifiers = { slow:0, medium:0.15, fast:0.30 };
let currentFilter = 'all';
let currentStoreTab = 'labs';
let selectedProduct = null;
let selectedDeadline = 'slow';

/* RENDER PRODUCTS */
function renderProducts(){
    const gridLabs=document.getElementById('grid-labs');
    const gridApps=document.getElementById('grid-apps');
    gridLabs.innerHTML=''; gridApps.innerHTML='';
    products.forEach(p=>{
        if(currentFilter!=='all' && !p.tags.includes(currentFilter)) return;
        const base = p.basePrice;
        const card = `
        <div class="product-card" onclick="openProductModal('${p.id}')">
            <div class="card-icon-box">${p.icon}</div>
            <div class="product-title">${p.title}</div>
            <div class="product-desc">${p.subtitle}</div>
            <div class="product-footer">
                <div class="price">${base} ‚ÇΩ</div>
                <div class="time">5‚Äì7 –¥–Ω–µ–π</div>
            </div>
            <div class="add-btn" onclick="event.stopPropagation();quickAdd('${p.id}')">+</div>
        </div>`;
        if(p.grid==='labs') gridLabs.insertAdjacentHTML('beforeend',card);
        else gridApps.insertAdjacentHTML('beforeend',card);
    });
}
function setFilter(tag){
    currentFilter=tag;
    document.querySelectorAll('.filter-pill').forEach(el=>{
        el.classList.toggle('active',el.dataset.filter===tag);
    });
    renderProducts();
}
function switchStoreTab(tab){
    currentStoreTab=tab;
    document.getElementById('grid-labs').classList.toggle('hidden',tab!=='labs');
    document.getElementById('grid-apps').classList.toggle('hidden',tab!=='apps');
    document.getElementById('tab-btn-labs').classList.toggle('active',tab==='labs');
    document.getElementById('tab-btn-apps').classList.toggle('active',tab==='apps');
    document.getElementById('tab-indicator').style.transform = tab==='labs' ? 'translateX(0)' : 'translateX(100%)';
}

/* NAV */
function openTab(name){
    ['store','custom','cart','orders','support'].forEach(v=>{
        document.getElementById('view-'+v).classList.add('hidden');
        const n=document.getElementById('nav-'+v);
        if(n) n.classList.remove('active');
    });
    document.getElementById('view-'+name).classList.remove('hidden');
    const navItem=document.getElementById('nav-'+name);
    if(navItem) navItem.classList.add('active');

    if(chatInterval){clearInterval(chatInterval);chatInterval=null;}
    if(name==='cart') renderCart();
    if(name==='orders') loadOrders();
    if(name==='support'){loadChat();chatInterval=setInterval(loadChat,3000);}
}

/* CART */
function updateCartBadge(){
    document.getElementById('cart-badge').style.display = cart.length?'block':'none';
}
function quickAdd(id){
    const p=products.find(x=>x.id===id); if(!p)return;
    addToCart(p.type,p.title,`${p.subtitle} ¬∑ –°—Ä–æ–∫: 5‚Äì7 –¥–Ω–µ–π`,p.basePrice);
}
function addToCart(type,name,desc,price){
    if(isProcessing) return;
    isProcessing=true;
    cart.push({type,name,desc,price});
    updateCartBadge();
    tg.showPopup({message:'‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ –≤ –∫–æ—Ä–∑–∏–Ω—É'});
    setTimeout(()=>isProcessing=false,400);
}
function renderCart(){
    const c=document.getElementById('cart-items');
    const f=document.getElementById('cart-footer');
    if(!cart.length){
        c.innerHTML='<div style="padding:40px;text-align:center;opacity:.5;">–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞ üõí</div>';
        f.classList.add('hidden');
        return;
    }
    f.classList.remove('hidden');
    c.innerHTML='';
    let total=0;
    cart.forEach((item,i)=>{
        total+=item.price;
        c.innerHTML+=`
        <div class="order-card" style="display:flex;justify-content:space-between;align-items:center;">
            <div>
                <div style="font-size:14px;font-weight:600;">${item.name}</div>
                <div style="font-size:12px;color:var(--text-secondary);">${item.desc||''}</div>
            </div>
            <div style="text-align:right;">
                <div style="color:var(--accent-cyan);font-weight:700;">${item.price} ‚ÇΩ</div>
                <button onclick="removeFromCart(${i})" style="border:none;background:transparent;color:var(--danger);font-size:16px;margin-top:4px;">‚úï</button>
            </div>
        </div>`;
    });
    let final=total;
    if(discount>0) final=Math.round(total*(1-discount/100));
    document.getElementById('cart-total').innerHTML = `${final} ‚ÇΩ ${discount>0?`<span style="font-size:12px;color:var(--success)">(-${discount}%)</span>`:''}`;
}
function removeFromCart(i){
    cart.splice(i,1);
    updateCartBadge();
    renderCart();
}

/* PRODUCT MODAL */
function openProductModal(id){
    selectedProduct=products.find(p=>p.id===id); if(!selectedProduct)return;
    selectedDeadline='slow';
    const slow=selectedProduct.basePrice;
    const med=Math.round(selectedProduct.basePrice*(1+priceModifiers.medium));
    const fast=Math.round(selectedProduct.basePrice*(1+priceModifiers.fast));
    document.getElementById('modal-title').textContent=selectedProduct.title;
    document.getElementById('modal-subtitle').textContent=selectedProduct.subtitle;
    document.getElementById('modal-desc').textContent=selectedProduct.desc;
    document.getElementById('price-slow').textContent=slow+' ‚ÇΩ';
    document.getElementById('price-medium').textContent=med+' ‚ÇΩ';
    document.getElementById('price-fast').textContent=fast+' ‚ÇΩ';
    document.querySelectorAll('.deadline-option').forEach(el=>el.classList.remove('active'));
    document.querySelector('.deadline-option[data-key="slow"]').classList.add('active');
    updateModalPrice();
    document.getElementById('product-modal-wrap').classList.remove('hidden');
}
function closeProductModal(e){
    document.getElementById('product-modal-wrap').classList.add('hidden');
}
function selectDeadline(key){
    selectedDeadline=key;
    document.querySelectorAll('.deadline-option').forEach(el=>el.classList.toggle('active',el.dataset.key===key));
    updateModalPrice();
}
function updateModalPrice(){
    if(!selectedProduct)return;
    const coeff=priceModifiers[selectedDeadline]||0;
    const price=Math.round(selectedProduct.basePrice*(1+coeff));
    document.getElementById('modal-price').textContent=price+' ‚ÇΩ';
}
function addFromModal(){
    if(!selectedProduct)return;
    const coeff=priceModifiers[selectedDeadline]||0;
    const price=Math.round(selectedProduct.basePrice*(1+coeff));
    const label=selectedDeadline==='slow'?'5‚Äì7 –¥–Ω–µ–π':selectedDeadline==='medium'?'2‚Äì4 –¥–Ω—è':'1 –¥–µ–Ω—å';
    addToCart(selectedProduct.type,selectedProduct.title,`${selectedProduct.subtitle} ¬∑ –°—Ä–æ–∫: ${label}`,price);
    closeProductModal();
}

/* CUSTOM ORDER */
document.getElementById('custom-file-input').addEventListener('change',async e=>{
    const file=e.target.files[0]; if(!file)return;
    if(file.size>10*1024*1024){tg.showAlert('–§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π');return;}
    const fd=new FormData();fd.append('file',file);
    try{
        const res=await fetch('/api/upload_file',{method:'POST',body:fd});
        const data=await res.json();
        if(data.file_url){
            customFileUrl=data.file_url;
            const label=document.getElementById('custom-file-label');
            label.textContent='‚úÖ '+file.name;
            label.style.color='var(--success)';
        }
    }catch(err){tg.showAlert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏');}
    e.target.value='';
});
async function submitCustomOrder(){
    const name=document.getElementById('custom-name').value.trim();
    const desc=document.getElementById('custom-desc').value.trim();
    if(!name){tg.showAlert('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ');return;}
    cart.push({type:'custom',name,desc,price:350,file_url:customFileUrl});
    customFileUrl='';
    document.getElementById('custom-name').value='';
    document.getElementById('custom-desc').value='';
    document.getElementById('custom-file-label').textContent='–ú–µ—Ç–æ–¥–∏—á–∫–∞, –ø—Ä–∏–º–µ—Ä, –∑–∞–¥–∞–Ω–∏–µ (–¥–æ 10 –ú–ë)';
    document.getElementById('custom-file-label').style.color='var(--text-secondary)';
    updateCartBadge();
    tg.showPopup({message:'‚úÖ –ó–∞–∫–∞–∑ –¥–æ–±–∞–≤–ª–µ–Ω –≤ –∫–æ—Ä–∑–∏–Ω—É'});
    openTab('cart');
}

/* PROMO + CHECKOUT  (–±–µ–∫–µ–Ω–¥ –ø–æ–∫–∞ —Ç–æ—Ç –∂–µ) */
async function checkPromo(){
    const code=document.getElementById('promo-input').value.trim();
    const resDiv=document.getElementById('promo-result');
    if(!code){discount=0;resDiv.textContent='';renderCart();return;}
    try{
        const res=await fetch('/api/check_promo',{
            method:'POST',headers:{'Content-Type':'application/json'},
            body:JSON.stringify({code})
        });
        const data=await res.json();
        if(data.valid){
            discount=data.discount;
            resDiv.innerHTML=`<span style="color:var(--success)">–°–∫–∏–¥–∫–∞ ${discount}% –ø—Ä–∏–º–µ–Ω–µ–Ω–∞!</span>`;
        }else{
            discount=0;
            resDiv.innerHTML=`<span style="color:var(--danger)">–ü—Ä–æ–º–æ–∫–æ–¥ –Ω–µ –Ω–∞–π–¥–µ–Ω</span>`;
        }
        renderCart();
    }catch(e){console.error(e);}
}
async function checkout(){
    if(!cart.length)return;
    try{
        tg.MainButton.showProgress();
        const promo=document.getElementById('promo-input').value.trim();
        const res=await fetch('/api/create_order',{
            method:'POST',headers:{'Content-Type':'application/json'},
            body:JSON.stringify({user_id:userId,username,cart,promo_code:promo})
        });
        const data=await res.json();
        if(data.status==='ok'){
            cart=[];discount=0;updateCartBadge();
            document.getElementById('promo-input').value='';
            document.getElementById('promo-result').textContent='';
            tg.showPopup({message:'‚úÖ –ó–∞–∫–∞–∑ —Å–æ–∑–¥–∞–Ω! –û–∂–∏–¥–∞–π—Ç–µ –æ—Ü–µ–Ω–∫—É.'});
            openTab('orders');
        }else{
            tg.showAlert('–û—à–∏–±–∫–∞: '+(data.message||'–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –∑–∞–∫–∞–∑'));
        }
        tg.MainButton.hideProgress();
    }catch(e){tg.MainButton.hideProgress();tg.showAlert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏');}
}

/* ORDERS (–∞–¥–º–∏–Ω-—Ñ–∞–π–ª—ã —Ä–µ–∞–ª–∏–∑—É–µ–º –≤ main.py, –Ω–æ –≤–µ—Ä—Å—Ç–∫–∞ –ø–æ–¥ –Ω–∏—Ö —É–∂–µ –µ—Å—Ç—å) */
async function loadOrders(){
    const list=document.getElementById('orders-list');
    list.innerHTML='<div style="padding:30px;text-align:center;opacity:.5;">–ó–∞–≥—Ä—É–∑–∫–∞...</div>';
    try{
        const res=await fetch('/api/get_orders?user_id='+userId);
        const data=await res.json();
        const orders=data.orders, isAdmin=data.is_admin;
        list.innerHTML=isAdmin?'<div style="text-align:center;color:var(--success);margin-bottom:8px;">üëë –†–µ–∂–∏–º –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</div>':'';
        if(!orders.length){
            list.innerHTML+='<div style="text-align:center; padding:40px; opacity:.5;">–ó–∞–∫–∞–∑–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç</div>';
            return;
        }
        orders.forEach(o=>{
            let statusText=o.status, statusColor='var(--text-secondary)';
            if(o.status==='wait_price'){statusText='–û—Ü–µ–Ω–∫–∞';}
            if(o.status==='wait_payment'){statusText='–ñ–¥—ë—Ç –æ–ø–ª–∞—Ç—ã';statusColor=varAccent('#A855F7');}
            if(o.status==='in_progress'){statusText='–í —Ä–∞–±–æ—Ç–µ';statusColor='#06B6D4';}
            if(o.status==='ready'){statusText='–ì–æ—Ç–æ–≤–æ';statusColor='#22C55E';}
            let adminHtml='', payHtml='', filesHtml='';
            if(o.files && o.files.length){
                filesHtml='<div style="margin-top:8px;font-size:12px;">';
                o.files.forEach(f=>{
                    filesHtml+=`<div>üìé <a href="${f.file_url}" target="_blank" style="color:#A5B4FC;">${f.file_name}</a></div>`;
                });
                filesHtml+='</div>';
            }
            if(isAdmin){
                adminHtml=`
                <div style="margin-top:10px;padding-top:8px;border-top:1px solid var(--glass-border);">
                    <div style="font-size:11px;color:var(--text-secondary);margin-bottom:4px;">–û—Ç: @${o.username||'unknown'} ¬∑ ID: ${o.user_id}</div>
                    <input id="price-${o.id}" type="number" value="${o.price||0}" placeholder="–¶–µ–Ω–∞">
                    <select id="status-${o.id}" style="margin-top:4px;">
                        <option value="wait_price" ${o.status==='wait_price'?'selected':''}>–û—Ü–µ–Ω–∫–∞</option>
                        <option value="wait_payment" ${o.status==='wait_payment'?'selected':''}>–ñ–¥—ë—Ç –æ–ø–ª–∞—Ç—ã</option>
                        <option value="in_progress" ${o.status==='in_progress'?'selected':''}>–í —Ä–∞–±–æ—Ç–µ</option>
                        <option value="ready" ${o.status==='ready'?'selected':''}>–ì–æ—Ç–æ–≤–æ</option>
                    </select>
                    <textarea id="comment-${o.id}" placeholder="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –º–µ–Ω–µ–¥–∂–µ—Ä–∞" style="margin-top:4px;min-height:50px;">${o.admin_comment||''}</textarea>
                    <label style="font-size:12px;display:flex;align-items:center;gap:6px;margin-top:4px;">
                        <input id="paid-${o.id}" type="checkbox" ${o.is_paid?'checked':''} style="width:auto;">–û–ø–ª–∞—á–µ–Ω–æ
                    </label>
                    <button onclick="uploadOrderFile(${o.id})" style="margin-top:6px;width:100%;border:none;background:rgba(15,23,42,.95);color:#E5E7EB;padding:7px;border-radius:9px;border:1px dashed var(--glass-border);">üìé –ü—Ä–∏–∫—Ä–µ–ø–∏—Ç—å —Ñ–∞–π–ª</button>
                    <button onclick="saveOrder(${o.id},${o.user_id})" style="margin-top:4px;width:100%;border:none;background:var(--success);color:white;padding:8px;border-radius:9px;">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                </div>`;
            }else if(o.status==='wait_payment' && !o.is_paid){
                payHtml=`
                <div style="margin-top:8px;padding:10px;border-radius:10px;background:rgba(15,23,42,.98);border:1px solid rgba(148,163,255,.5);">
                    <div>–ö –æ–ø–ª–∞—Ç–µ: <b>${o.price} ‚ÇΩ</b></div>
                    <div style="margin:6px 0;font-family:monospace;letter-spacing:2px;">2202 2081 6267 4528</div>
                    <button onclick="navigator.clipboard.writeText('2202208162674528');tg.showPopup({message:'–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ'})" style="border:none;background:white;color:black;padding:6px 14px;border-radius:999px;font-size:12px;font-weight:600;">–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –Ω–æ–º–µ—Ä</button>
                </div>`;
            }
            list.innerHTML+=`
            <div class="order-card">
                <div style="display:flex;justify-content:space-between;align-items:center;">
                    <div style="font-weight:600;">#${o.id} ${o.item_name}</div>
                    <span style="font-size:11px;border-radius:999px;border:1px solid ${statusColor};padding:2px 8px;color:${statusColor};">${statusText}</span>
                </div>
                ${o.description?`<div style="font-size:13px;color:var(--text-secondary);margin-top:4px;">${o.description}</div>`:''}
                ${o.price?`<div style="margin-top:4px;color:var(--accent-cyan);font-weight:700;">${o.price} ‚ÇΩ</div>`:''}
                ${o.admin_comment?`<div style="margin-top:4px;font-size:12px;background:rgba(15,23,42,.95);padding:6px;border-radius:8px;">üí¨ ${o.admin_comment}</div>`:''}
                ${filesHtml}
                ${payHtml}
                ${adminHtml}
            </div>`;
        });
    }catch(e){list.innerHTML='–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏';}
}
function varAccent(def){return def;}
async function saveOrder(oid,uid){
    await fetch('/api/update_order',{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({
            admin_id:userId,
            order_id:oid,
            user_id:uid,
            price:parseInt(document.getElementById('price-'+oid).value)||0,
            status:document.getElementById('status-'+oid).value,
            admin_comment:document.getElementById('comment-'+oid).value,
            is_paid:document.getElementById('paid-'+oid).checked
        })
    });
    loadOrders();
}
function uploadOrderFile(orderId){
    const inp=document.getElementById('order-file-input');
    inp.setAttribute('data-order-id',orderId);
    inp.click();
}
document.getElementById('order-file-input').addEventListener('change',async e=>{
    const file=e.target.files[0];
    const orderId=e.target.getAttribute('data-order-id');
    if(!file||!orderId) return;
    const fd=new FormData();
    fd.append('file',file);
    fd.append('order_id',orderId);
    fd.append('admin_id',userId);
    try{
        const res=await fetch('/api/add_order_file',{method:'POST',body:fd});
        const data=await res.json();
        if(data.status==='ok'){tg.showPopup({message:'‚úÖ –§–∞–π–ª –ø—Ä–∏–∫—Ä–µ–ø–ª—ë–Ω'});loadOrders();}
        else tg.showAlert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞');
    }catch(err){tg.showAlert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏');}
    e.target.value='';
});

/* CHAT */
async function loadChat(){
    try{
        const res=await fetch('/api/get_chat?user_id='+userId);
        const data=await res.json();
        const box=document.getElementById('chat-history');
        const wasBottom=box.scrollTop+box.clientHeight>=box.scrollHeight-40;
        box.innerHTML='';
        if(!data.messages||!data.messages.length){
            box.innerHTML='<div style="text-align:center;padding:30px;opacity:.5;">–ù–∞–ø–∏—à–∏—Ç–µ –Ω–∞–º, –º—ã –ø–æ–º–æ–∂–µ–º üéÑ</div>';
            return;
        }
        data.messages.forEach(m=>{
            let filePart=m.file_url?`<br><a href="${m.file_url}" target="_blank" style="color:#A5B4FC;text-decoration:underline;">üìé –§–∞–π–ª</a>`:'';
            box.innerHTML+=`<div class="msg msg-${m.sender}">${m.message||''}${filePart}<span class="msg-time">${m.timestamp?m.timestamp.substring(11,16):''}</span></div>`;
        });
        if(wasBottom) box.scrollTop=box.scrollHeight;
    }catch(e){}
}
async function sendMessage(){
    const el=document.getElementById('chat-input');
    const text=el.value.trim(); if(!text)return;
    el.value='';
    await fetch('/api/send_message',{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({user_id:userId,username,message:text})
    });
    loadChat();
}
document.getElementById('file-input').addEventListener('change',async e=>{
    const file=e.target.files[0];if(!file)return;
    if(file.size>10*1024*1024){tg.showAlert('–§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π');return;}
    const fd=new FormData();fd.append('file',file);
    const res=await fetch('/api/upload_file',{method:'POST',body:fd});
    const data=await res.json();
    if(data.file_url){
        await fetch('/api/send_message',{
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body:JSON.stringify({user_id:userId,username,message:"üìé –§–∞–π–ª",file_url:data.file_url})
        });
        loadChat();
    }
    e.target.value='';
});

/* INIT */
renderProducts();
openTab('store');
switchStoreTab('labs');
</script>
</body>
</html>